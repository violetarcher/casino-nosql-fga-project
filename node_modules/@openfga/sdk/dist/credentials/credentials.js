"use strict";
/**
 * JavaScript and Node.js SDK for OpenFGA
 *
 * API version: 0.1
 * Website: https://openfga.dev
 * Documentation: https://openfga.dev/docs
 * Support: https://openfga.dev/community
 * License: [Apache-2.0](https://github.com/openfga/js-sdk/blob/main/LICENSE)
 *
 * NOTE: This file was auto generated by OpenAPI Generator (https://openapi-generator.tech). DO NOT EDIT.
 */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Credentials = void 0;
const axios_1 = require("axios");
const validation_1 = require("../validation");
const errors_1 = require("../errors");
const common_1 = require("../common");
const types_1 = require("./types");
class Credentials {
    static init(configuration) {
        return new Credentials(configuration.credentials);
    }
    constructor(authConfig, axios = axios_1.default) {
        this.authConfig = authConfig;
        this.axios = axios;
        this.initConfig();
        this.isValid();
    }
    /**
     * Sets the default config values
     * @private
     */
    initConfig() {
        var _a;
        switch ((_a = this.authConfig) === null || _a === void 0 ? void 0 : _a.method) {
            case types_1.CredentialsMethod.ApiToken:
                if (this.authConfig.config) {
                    if (!this.authConfig.config.headerName) {
                        this.authConfig.config.headerName = "Authorization";
                    }
                    if (!this.authConfig.config.headerValuePrefix) {
                        this.authConfig.config.headerValuePrefix = "Bearer";
                    }
                }
                break;
            case types_1.CredentialsMethod.ClientCredentials:
            case types_1.CredentialsMethod.None:
            default:
                break;
        }
    }
    /**
     *
     * @throws {FgaValidationError}
     */
    isValid() {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j;
        const { authConfig } = this;
        switch (authConfig === null || authConfig === void 0 ? void 0 : authConfig.method) {
            case types_1.CredentialsMethod.None:
                break;
            case types_1.CredentialsMethod.ApiToken:
                (0, validation_1.assertParamExists)("Credentials", "config.token", (_a = authConfig.config) === null || _a === void 0 ? void 0 : _a.token);
                (0, validation_1.assertParamExists)("Credentials", "config.headerName", (_b = authConfig.config) === null || _b === void 0 ? void 0 : _b.headerName);
                (0, validation_1.assertParamExists)("Credentials", "config.headerName", (_c = authConfig.config) === null || _c === void 0 ? void 0 : _c.headerName);
                break;
            case types_1.CredentialsMethod.ClientCredentials:
                (0, validation_1.assertParamExists)("Credentials", "config.clientId", (_d = authConfig.config) === null || _d === void 0 ? void 0 : _d.clientId);
                (0, validation_1.assertParamExists)("Credentials", "config.clientSecret", (_e = authConfig.config) === null || _e === void 0 ? void 0 : _e.clientSecret);
                (0, validation_1.assertParamExists)("Credentials", "config.apiTokenIssuer", (_f = authConfig.config) === null || _f === void 0 ? void 0 : _f.apiTokenIssuer);
                (0, validation_1.assertParamExists)("Credentials", "config.apiAudience", (_g = authConfig.config) === null || _g === void 0 ? void 0 : _g.apiAudience);
                if (!(0, validation_1.isWellFormedUriString)(`https://${(_h = authConfig.config) === null || _h === void 0 ? void 0 : _h.apiTokenIssuer}`)) {
                    throw new errors_1.FgaValidationError(`Configuration.apiTokenIssuer does not form a valid URI (https://${(_j = authConfig.config) === null || _j === void 0 ? void 0 : _j.apiTokenIssuer})`);
                }
                break;
        }
    }
    /**
     * Get access token, request a new one if not cached or expired
     * @return string
     */
    getAccessTokenHeader() {
        return __awaiter(this, void 0, void 0, function* () {
            var _a;
            const accessTokenValue = yield this.getAccessTokenValue();
            switch ((_a = this.authConfig) === null || _a === void 0 ? void 0 : _a.method) {
                case types_1.CredentialsMethod.None:
                    return;
                case types_1.CredentialsMethod.ApiToken:
                    return {
                        name: this.authConfig.config.headerName,
                        value: `${this.authConfig.config.headerValuePrefix ? `${this.authConfig.config.headerValuePrefix} ` : ""}${accessTokenValue}`
                    };
                case types_1.CredentialsMethod.ClientCredentials:
                    return {
                        name: "Authorization",
                        value: `Bearer ${accessTokenValue}`
                    };
            }
        });
    }
    getAccessTokenValue() {
        return __awaiter(this, void 0, void 0, function* () {
            var _a;
            switch ((_a = this.authConfig) === null || _a === void 0 ? void 0 : _a.method) {
                case types_1.CredentialsMethod.None:
                    return;
                case types_1.CredentialsMethod.ApiToken:
                    return this.authConfig.config.token;
                case types_1.CredentialsMethod.ClientCredentials:
                    if (this.accessToken && (!this.accessTokenExpiryDate || this.accessTokenExpiryDate > new Date())) {
                        return this.accessToken;
                    }
                    return this.refreshAccessToken();
            }
        });
    }
    /**
     * Request new access token
     * @return string
     */
    refreshAccessToken() {
        return __awaiter(this, void 0, void 0, function* () {
            var _a;
            const clientCredentials = (_a = this.authConfig) === null || _a === void 0 ? void 0 : _a.config;
            try {
                const response = yield (0, common_1.attemptHttpRequest)({
                    url: `https://${clientCredentials.apiTokenIssuer}/oauth/token`,
                    method: "post",
                    data: {
                        client_id: clientCredentials.clientId,
                        client_secret: clientCredentials.clientSecret,
                        audience: clientCredentials.apiAudience,
                        grant_type: "client_credentials",
                    },
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    }
                }, {
                    maxRetry: 3,
                    minWaitInMs: 100,
                }, axios_1.default);
                if (response) {
                    this.accessToken = response.data.access_token;
                    this.accessTokenExpiryDate = new Date(Date.now() + response.data.expires_in * 1000);
                }
                return this.accessToken;
            }
            catch (err) {
                if (err instanceof errors_1.FgaApiError) {
                    err.constructor = errors_1.FgaApiAuthenticationError;
                    err.name = "FgaApiAuthenticationError";
                    err.clientId = clientCredentials.clientId;
                    err.audience = clientCredentials.apiAudience;
                    err.grantType = "client_credentials";
                }
                throw err;
            }
        });
    }
}
exports.Credentials = Credentials;
